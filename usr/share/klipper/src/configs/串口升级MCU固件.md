# 串口升级MCU固件



## 版本信息

上位机文件系统中集成了内部klipper_440x仓库，在其中新建一个fw文件夹，用于存放各个机型下位机小板MCU的固件，但仅保留最新版本的固件。

为了便于识别与开发使用，硬件版本与软件版本信息都需要体现在固件名称上。在配置编译下位机固件时，根据一定规则，进行自动重命名操作。



### 硬件版本

硬件版本需要包含三种信息：小板类型（mcu、nozzle、bed等）、硬件版本、MCU型号。

格式定义：

1. 以上三种信息之间，用下划线作为分隔符，分别占用4、3、3个字符，包括下划线共12个字符，如下表；
2. 预留存在多个同类型小板的情况，所有类型后均保留一个数字以示区分，如下表；

2. 因为MCU型号细分类型较多，同一个大类可能有不同型号的MCU同时使用，所以需要做个映射表，减少字符占用。第1个字符代表厂商品牌，如ST用S表示，GD用G表示；第2个字符代表大系列，如4xx用4表示，0xx用0表示；第3个字符代表第几个适配的型号，由0开始，依次递增。如下表；

| 小板类型 | 硬件版本 |      MCU型号       |  最终字符串  |
| :------: | :------: | :----------------: | :----------: |
|   mcu0   |  1.0.0   | STM32F401 --> S40  | mcu0_100_S40 |
|   mcu0   |  1.0.1   | GD32F303XE --> G32 | mcu0_101_G32 |
|   noz0   |  1.0.1   | STM32G071 --> S06  | noz0_101_S06 |
|   noz1   |  1.0.1   | STM32G071 --> S06  | noz1_101_S06 |
|   bed0   |  0.0.1   | GD32E230X8 --> G21 | bed0_001_G21 |



### 软件版本

软件版本需要包含两种信息：小板类型、固件版本，剩余的用作预留。

格式定义：

1. 以上三种信息之间，同样用下划线作为分隔符，分别占用4、3、3个字符，包括下划线共12个字符，如下表；
2. 预留存在多个同类型小板的情况，所有类型后均保留一个数字以示区分，如下表；

| 小板类型 | 固件版本 | 预留 |  最终字符串  |
| :------: | :------: | :--: | :----------: |
|   mcu0   |  0.1.0   | 000  | mcu0_010_000 |
|   noz0   |  0.1.1   | 000  | noz0_011_000 |
|   noz1   |  0.1.2   | 000  | noz1_012_000 |
|   bed0   |  0.2.0   | 000  | bed0_020_000 |



## 板型管理

修改klipper的Kconfig及Makefile，详细见klipper_440x内部仓库提交。主要特性如下：

1. 支持新增板型信息（如小板类型、硬件版本、软件版本及MCU型号等）配置，并**人工手动**保留到 src/configs/***_defconfig，如果有需要则配置文件以机型+硬件版本来命名区分（如K1和H1的喷头板硬件原理图设计不一样），或者仅使用硬件版本命名（如上位机主板已集成主MCU），目录树大致如下：

   ```
   src/configs/
   ├── K1_bed0_100_G21_defconfig
   ├── K1_noz0_110_S06_defconfig
   ├── Kconfig
   ├── mcu0_110_G32_defconfig
   └── mcu0_110_S40_defconfig
   ```

2. 支持板型的软件版本存至ROM特定区域，暂定为中断向量表基地址 + 512个字节偏移处，大小32个字节；供bootloader读取，返回给上位机升级管理程序

3. 支持自动获取硬件版本和软件版本，在编译得到固件后进行复制重命名，见下面的固件管理章节。



## 固件管理

在内部klipper_440x仓库根目录中新建一个fw文件夹，在其内部新建一些调试支持的机型名文件夹，如K1（K1 Max目前共用），用于存放各个MCU下位机固件。目录树大致如下：

```
fw/
└── K1
    ├── bed0_100_G21-bed0_000_000.bin
    ├── mcu0_110_G32-mcu0_000_000.bin
    └── noz0_110_S06-noz0_000_000.bin
```



## 升级管理程序

为了保持灵活和便捷，可以配合脚本一起使用，主要特性如下：

1. 支持进行单一的握手操作，避免因升级时间较长加上排队等待时间较久，bootloader已超时（暂定15秒）并跳转启动APP
2. 在已握手前提下，支持单独获取硬件版本和软件版本返回，在shell脚本中寻找匹配，确定是否需要升级，不需要则直接跳转启动APP
3. 支持在匹配硬件版本情况下，不对比软件版本高低，直接强制升级固件，即强制升级模式（待实现）
4. 支持不通过硬件版本匹配，也不对比软件版本高低，直接强制升级固件，即强制调试模式（待实现）

代码仓库：http://172.23.88.26:3333/wuhui/mcu_update



## 支持列表（持续更新）

记录已经开发支持的板型，除了常规的软硬件版本信息外，还加上一些主要的配置项详情。

| 机型 | 小板类型 |   硬件版本   |      MCU型号       | bootloader偏移 |     通讯接口     | 串口波特率 |    GPIO初始化    |       板型配置文件        |
| :--: | :------: | :----------: | :----------------: | :------------: | :--------------: | :--------: | :--------------: | :-----------------------: |
|  K1  |   mcu0   |  S11-->110   | GD32F303XE --> G32 |      12KB      | usart1(PA2/PA3)  |   230400   |     PC7,PB0      |  mcu0_110_G32_defconfig   |
|  K1  |   noz0   |  V1.1-->110  | STM32G071 --> S06  |      12KB      | usart2(PA2/PA3)  |   230400   | !PB14,!PB15,!PA8 | K1_noz0_110_S06_defconfig |
|  K1  |   bed0   | V1.1.0-->110 | GD32E230X8 --> G21 |      12KB      | usart0(PA9/PA10) |   230400   |        无        | K1_bed0_110_G21_defconfig |
|  K1  |   noz0   | v12 -->120   | GD32F303xB --> G30 |      12KB      | usart1(PA2/PA3)  |   230400   | !PB5,!PB6,!PB7   | K1_noz0_120_G30_defconfig |
|      |          |              |                    |                |                  |            |                  |                           |

